name: Auto Time Tracking

on:
  push:
    branches: [ main, master ]

jobs:
  track-time:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Extract Time and Issue from Commit
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.payload.head_commit;
            const message = commit.message;
            
            // Extract time patterns: "1h", "2hr", "30m", "1.5h"
            const timeMatch = message.match(/(\d+(?:\.\d+)?)(h|hr|hours?|m|min|minutes?)/i);
            
            // Extract issue references: "#1", "fixes #2", "closes #3"
            const issueMatch = message.match(/#(\d+)/);
            
            if (timeMatch && issueMatch) {
              const timeSpent = timeMatch[0];
              const issueNumber = issueMatch[1];
              const commitSha = commit.id.substring(0, 7);
              
              // Get commit stats
              const { data: commitData } = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: commit.id
              });
              
              const stats = commitData.stats;
              const files = commitData.files.map(f => f.filename).join(', ');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `â±ï¸ **${timeSpent}** - ${new Date().toLocaleDateString()}
                
ğŸ“ **Commit:** ${commitSha} - ${message.split('\n')[0]}
ğŸ“Š **Changes:** +${stats.additions} -${stats.deletions} lines
ğŸ“ **Files:** ${files}
ğŸ”— [View commit](${commit.url})`
              });
            }
