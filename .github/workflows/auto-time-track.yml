name: Auto Time Tracking

on:
  push:
    branches: [ main, master ]

jobs:
  track-time:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Extract Time and Issue from Commit
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.payload.head_commit;
            const message = commit.message;
            
            const timeMatch = message.match(/(\d+(?:\.\d+)?)(h|hr|hours?|m|min|minutes?)/i);
            const issueMatch = message.match(/#(\d+)/);
            
            if (timeMatch && issueMatch) {
              const timeSpent = timeMatch[0];
              const issueNumber = issueMatch[1];
              const commitSha = commit.id.substring(0, 7);
              
              const { data: commitData } = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: commit.id
              });
              
              const stats = commitData.stats;
              const files = commitData.files.map(f => f.filename).join(', ');
              
              const timeMessage = 'â±ï¸ **' + timeSpent + '** - ' + new Date().toLocaleDateString() + '\n\nğŸ“ **Commit:** ' + commitSha + ' - ' + message.split('\n')[0] + '\nğŸ“Š **Changes:** +' + stats.additions + ' -' + stats.deletions + ' lines\nğŸ“ **Files:** ' + files + '\nğŸ”— [View commit](' + commit.url + ')';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: timeMessage
              });
            }
